# 最终解决方案：加载 MySQL 时区数据

## 问题根源

代码中使用了 `TruncDay('created_time')` 函数（在 `server/system/views/dashboard.py` 第 29 行）。

当 Django 的 `USE_TZ = True` 时，`TruncDay` 等 datetime 函数需要数据库支持时区转换。虽然 MySQL 时区已设置为 `+08:00`，但如果时区数据未加载，这些函数仍然无法正常工作。

## 解决方案：加载 MySQL 时区数据

### 步骤 1：安装 mysql-server-core-8.0

```bash
apt install mysql-server-core-8.0
```

### 步骤 2：加载时区数据

```bash
mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql
```

输入 MySQL root 密码后，时区数据将被加载到 `mysql` 数据库的时区表中。

### 步骤 3：验证时区数据已加载

```bash
mysql -u root -p -e "SELECT COUNT(*) FROM mysql.time_zone_name;"
```

**应该返回一个大于 0 的数字（通常是 1000+）。**

```bash
mysql -u root -p -e "SELECT * FROM mysql.time_zone_name WHERE Name LIKE 'Asia/%' LIMIT 5;"
```

应该能看到时区列表，包括 `Asia/Shanghai`。

### 步骤 4：重启 Django 服务

```bash
# 在宝塔面板中重启 Python 项目
# 或使用命令重启 Django 服务
```

### 步骤 5：测试 API

```bash
curl http://127.0.0.1:8896/api/system/dashboard/today-operate-total
```

应该返回正常数据，而不是 500 错误。

## 为什么需要时区数据？

虽然使用 `+08:00` 偏移量不需要时区数据，但 Django 的 `TruncDay`、`TruncHour` 等函数在 `USE_TZ = True` 时，需要数据库能够：
1. 理解时区概念
2. 进行时区转换
3. 正确处理 datetime 值

这些功能需要时区数据支持。

## 验证清单

- [ ] `mysql-server-core-8.0` 已安装
- [ ] 时区数据已加载（`mysql.time_zone_name` 表有记录）
- [ ] Django 服务已重启
- [ ] API 测试正常
- [ ] 前端不再显示时区错误

## 如果仍然有问题

### 检查时区数据是否正确加载

```bash
mysql -u root -p -e "SELECT COUNT(*) FROM mysql.time_zone_name;"
mysql -u root -p -e "SELECT * FROM mysql.time_zone_name WHERE Name = 'Asia/Shanghai';"
```

### 检查 Django 日志

查看具体的错误信息，确认是否是时区相关的问题。

### 临时测试：禁用 USE_TZ（不推荐）

如果加载时区数据后仍然有问题，可以临时测试：

**修改 `server/server/settings/base.py`：**
```python
USE_TZ = False  # 临时改为 False
```

**注意：** 这只是用于测试，不推荐在生产环境使用。如果这样可以解决问题，说明确实是时区数据的问题。





