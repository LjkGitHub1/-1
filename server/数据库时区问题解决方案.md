# 数据库时区问题解决方案

## 错误信息

```
Database returned an invalid datetime value. Are time zone definitions for your database installed?
```

## 问题原因

当 Django 的 `USE_TZ = True` 时，Django 会使用数据库的时区支持。如果数据库（特别是 PostgreSQL）没有安装时区数据，就会出现这个错误。

## 解决方案

### 方案 1：PostgreSQL 数据库（推荐）

如果使用 PostgreSQL，需要安装时区数据：

#### 1. 检查时区数据是否已安装

```bash
# 连接到 PostgreSQL
psql -U your_user -d your_database

# 在 PostgreSQL 中执行
SELECT * FROM pg_timezone_names WHERE name = 'Asia/Shanghai';
```

如果查询返回空结果，说明时区数据未安装。

#### 2. 安装时区数据

**Ubuntu/Debian:**
```bash
sudo apt-get install postgresql-contrib
# 或者
sudo apt-get install postgresql-common
```

**CentOS/RHEL:**
```bash
sudo yum install postgresql-contrib
```

**在 PostgreSQL 中初始化时区数据:**
```bash
# 连接到 PostgreSQL
sudo -u postgres psql your_database

# 执行以下 SQL
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

#### 3. 验证时区数据

```sql
-- 在 PostgreSQL 中执行
SELECT * FROM pg_timezone_names WHERE name LIKE 'Asia/%' LIMIT 10;
```

应该能看到时区列表。

### 方案 2：MySQL 数据库

如果使用 MySQL，通常不需要额外安装时区数据，但需要确保：

1. **检查 MySQL 时区表是否存在:**
```sql
SELECT * FROM mysql.time_zone_name LIMIT 10;
```

2. **如果表不存在，加载时区数据:**
```bash
# Linux
mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql

# macOS
mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql
```

### 方案 3：临时解决方案（不推荐）

如果无法安装时区数据，可以临时禁用 Django 的时区支持：

**修改 `server/server/settings/base.py`:**
```python
# 将
USE_TZ = True
# 改为
USE_TZ = False
```

**注意：** 这会导致时区处理不一致，不推荐在生产环境使用。

### 方案 4：检查数据库连接配置

确保数据库连接配置正确，特别是 PostgreSQL：

**检查 `server/server/settings/base.py` 中的数据库配置:**
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',  # 或 postgresql_psycopg2
        'NAME': CONFIG.DB_DATABASE,
        'HOST': CONFIG.DB_HOST,
        'PORT': CONFIG.DB_PORT,
        'USER': CONFIG.DB_USER,
        'PASSWORD': CONFIG.PASSWORD,
        'OPTIONS': {
            # 可以添加时区选项
            'options': '-c timezone=Asia/Shanghai'
        }
    }
}
```

## 验证修复

修复后，重启 Django 服务并测试：

```bash
# 重启 Django
# 根据您的部署方式重启服务

# 测试 API
curl http://127.0.0.1:8896/api/system/dashboard/user-login-trend
```

## 常见问题

### Q: 如何检查当前使用的数据库类型？

A: 查看 `server/server/settings/base.py` 中的 `DB_ENGINE` 配置，或检查 `config.yml` 文件。

### Q: PostgreSQL 时区数据安装后仍然报错？

A: 确保：
1. PostgreSQL 服务已重启
2. Django 数据库连接已重新建立
3. 检查 PostgreSQL 日志是否有错误

### Q: 时间显示为 2025 年（未来时间）？

A: 这可能是系统时间或数据库时间配置错误。检查：
```bash
# 检查系统时间
date

# 检查数据库时间
# PostgreSQL
psql -U your_user -d your_database -c "SELECT NOW();"

# MySQL
mysql -u your_user -p -e "SELECT NOW();"
```

## 推荐配置

对于生产环境，推荐：
1. 使用 PostgreSQL 并安装时区数据
2. 保持 `USE_TZ = True`
3. 设置 `TIME_ZONE = 'Asia/Shanghai'`
4. 确保数据库和系统时区一致

