# 宝塔 Nginx 配置说明

## 问题原因

Nginx 启动失败是因为 `server/utils/nginx.conf` 文件（Docker 环境配置）被错误加载，该文件包含 `listen 8896` 的 stream 配置，导致端口冲突。

**8896 端口应该由 Django 后端使用，Nginx 不应该监听它！**

## 解决步骤

### 1. 检查并移除错误的配置

在宝塔面板中：

1. 打开 **软件商店** → **已安装** → **Nginx** → **设置** → **配置修改**
2. 检查主配置文件（通常是 `/www/server/nginx/conf/nginx.conf`）
3. **确保没有包含 `server/utils/nginx.conf` 的引用**
4. **确保没有 `stream` 块监听 8896 端口**

### 2. 创建站点配置

1. 在宝塔面板中，进入 **网站** → **添加站点**
2. 填写域名或IP（如：`36.134.27.102`）
3. 选择 **纯静态** 或 **PHP 项目**（不影响，因为我们用 Nginx 代理）
4. 创建站点后，点击站点右侧的 **设置** → **配置文件**

### 3. 复制配置内容

将 `client/nginx-baota.conf` 文件的内容复制到站点配置文件中，并修改以下内容：

- **`server_name`**: 改为您的域名或IP
- **`root`**: 改为您的前端构建文件目录（如：`/www/wwwroot/your-site/dist`）
- **日志路径**: 根据需要修改日志文件路径

### 4. 重要配置说明

- **`/api`**: 代理到 `http://127.0.0.1:8896`（Django 后端）
- **`/media`**: 代理到 `http://127.0.0.1:8896`（媒体文件）
- **`/ws`**: 代理到 `http://127.0.0.1:8896`（WebSocket）
- **`/api-docs`**: 代理到 `http://127.0.0.1:8896`（API 文档）

### 5. 测试配置

1. 在宝塔面板中，点击 **Nginx** → **重载配置**
2. 如果配置有误，会显示错误信息
3. 配置正确后，访问您的网站测试

### 6. 确保 Django 后端运行

确保 Django 后端正在 `127.0.0.1:8896` 上运行：

```bash
# 检查端口是否被占用
netstat -tlnp | grep 8896

# 或使用 ss 命令
ss -tlnp | grep 8896
```

## 注意事项

1. **不要**将 `server/utils/nginx.conf` 作为主配置文件使用（这是 Docker 环境的配置）
2. **不要**在 Nginx 中监听 8896 端口（这是 Django 的端口）
3. Nginx 只监听 80 端口（或 443 如果使用 HTTPS），然后代理到 Django
4. 确保 Django 后端在 `127.0.0.1:8896` 上运行

## 常见问题

### Q: 仍然出现端口冲突？

A: 检查是否有其他 Nginx 配置文件包含 `listen 8896`，或者检查是否有其他进程占用 8896 端口。

### Q: 前端可以访问，但 API 请求失败？

A: 检查 Django 后端是否在 `127.0.0.1:8896` 上运行，以及 Nginx 代理配置是否正确。

### Q: WebSocket 连接失败？

A: 确保 `/ws` 的 location 配置了正确的 `Upgrade` 和 `Connection` 头。
